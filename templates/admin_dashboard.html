<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>사용자 이벤트 관리자 대시보드</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Roboto', 'Noto Sans KR', Arial, sans-serif;
            background: linear-gradient(120deg, #f8fafc 0%, #e2e8f0 100%);
            margin: 0; padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .header h1 {
            color: #2d3748;
            margin: 0 0 8px 0;
            font-size: 2.2em;
        }
        .header p {
            color: #718096;
            margin: 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card h3 {
            color: #4a5568;
            margin: 0 0 8px 0;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-card .value {
            color: #2d3748;
            font-size: 2.5em;
            font-weight: 700;
            margin: 0;
        }
        .stat-card .change {
            color: #38a169;
            font-size: 0.9em;
            margin-top: 8px;
        }
        .chart-container {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .chart-container h3 {
            color: #2d3748;
            margin: 0 0 20px 0;
            font-size: 1.3em;
        }
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        .controls {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .controls h3 {
            color: #2d3748;
            margin: 0 0 16px 0;
            font-size: 1.3em;
        }
        .button {
            background: #4299e1;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-right: 12px;
            margin-bottom: 12px;
            transition: background 0.2s;
        }
        .button:hover {
            background: #3182ce;
        }
        .button.danger {
            background: #e53e3e;
        }
        .button.danger:hover {
            background: #c53030;
        }
        .button.success {
            background: #38a169;
        }
        .button.success:hover {
            background: #2f855a;
        }
        .table-container {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        .table-container h3 {
            color: #2d3748;
            margin: 0 0 20px 0;
            font-size: 1.3em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }
        tr:hover {
            background: #f7fafc;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .success {
            background: #c6f6d5;
            color: #2f855a;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>사용자 이벤트 관리자 대시보드</h1>
            <p>사용자 행동 데이터 분석 및 LightGCN 추천 시스템 관리</p>
        </div>

        <!-- 통계 카드 -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>총 사용자 수</h3>
                <div class="value" id="total-users">-</div>
            </div>
            <div class="stat-card">
                <h3>총 상품 조회 수</h3>
                <div class="value" id="total-views">-</div>
            </div>
            <div class="stat-card">
                <h3>총 검색 수</h3>
                <div class="value" id="total-searches">-</div>
            </div>
            <div class="stat-card">
                <h3>오늘 상품 조회 수</h3>
                <div class="value" id="today-views">-</div>
            </div>
        </div>

        <!-- LightGCN 데이터 상태 -->
        <div class="chart-container">
            <h3>LightGCN 데이터 상태</h3>
            <div id="lightgcn-status">
                <div class="loading">데이터 로딩 중...</div>
            </div>
        </div>

        <!-- 사용자 활동 차트 -->
        <div class="chart-container">
            <h3>사용자 활동 추이 (최근 7일)</h3>
            <div class="chart-wrapper">
                <canvas id="activityChart"></canvas>
            </div>
        </div>

        <!-- 카테고리별 통계 -->
        <div class="chart-container">
            <h3>카테고리별 상품 조회 수</h3>
            <div class="chart-wrapper">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>

        <!-- 관리 컨트롤 -->
        <div class="controls">
            <h3>데이터 관리</h3>
            <div style="margin-bottom: 20px;">
                <label for="period-select" style="margin-right: 10px; font-weight: 600;">기간 선택:</label>
                <select id="period-select" onchange="changePeriod()" style="padding: 8px; border-radius: 6px; border: 1px solid #e2e8f0; margin-right: 15px;">
                    <option value="7">최근 7일</option>
                    <option value="14">최근 14일</option>
                    <option value="30">최근 30일</option>
                    <option value="90">최근 90일</option>
                    <option value="all">전체 기간</option>
                </select>
                <button class="button" onclick="loadPeriodStats()">기간별 통계 조회</button>
            </div>
            <button class="button success" onclick="regenerateLightGCNData()">LightGCN 데이터 재생성</button>
            <button class="button" onclick="refreshStats()">통계 새로고침</button>
            <button class="button" onclick="exportData()">데이터 내보내기</button>
            <button class="button danger" onclick="showResetConfirm()">통계 데이터 초기화</button>
        </div>

        <!-- 기간별 통계 섹션 -->
        <div class="chart-container" id="period-stats-section" style="display: none;">
            <h3>기간별 통계</h3>
            <div id="period-stats-content">
                <div class="loading">기간별 통계 로딩 중...</div>
            </div>
        </div>

        <!-- 인기 상품 테이블 -->
        <div class="table-container">
            <h3>인기 상품 TOP 10</h3>
            <div id="popular-products">
                <div class="loading">데이터 로딩 중...</div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let activityChart, categoryChart;
        let currentPeriod = 7;

        // 페이지 로드 시 데이터 로드
        document.addEventListener('DOMContentLoaded', function() {
            loadStatistics();
            loadLightGCNStatus();
            loadUserActivity();
            loadCategoryStats();
            loadPopularProducts();
            
            // 확인 텍스트 입력 이벤트
            document.getElementById('confirm-text').addEventListener('input', function() {
                const confirmBtn = document.getElementById('confirm-reset-btn');
                confirmBtn.disabled = this.value !== '초기화';
            });
        });

        // 통계 데이터 로드
        async function loadStatistics() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.status === 'success') {
                    document.getElementById('total-users').textContent = data.data.total_users.toLocaleString();
                    document.getElementById('total-views').textContent = data.data.total_views.toLocaleString();
                    document.getElementById('total-searches').textContent = data.data.total_searches.toLocaleString();
                    document.getElementById('today-views').textContent = data.data.today_views.toLocaleString();
                }
            } catch (error) {
                console.error('통계 로드 오류:', error);
            }
        }

        // LightGCN 상태 로드
        async function loadLightGCNStatus() {
            try {
                const response = await fetch('/api/lightgcn_data');
                const data = await response.json();
                
                const container = document.getElementById('lightgcn-status');
                
                if (data.status === 'success') {
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div style="text-align: center; padding: 16px; background: #f7fafc; border-radius: 8px;">
                                <div style="font-size: 2em; font-weight: 700; color: #4299e1;">${data.data.n_users}</div>
                                <div style="color: #718096;">사용자 수</div>
                            </div>
                            <div style="text-align: center; padding: 16px; background: #f7fafc; border-radius: 8px;">
                                <div style="font-size: 2em; font-weight: 700; color: #38a169;">${data.data.n_products}</div>
                                <div style="color: #718096;">상품 수</div>
                            </div>
                            <div style="text-align: center; padding: 16px; background: #f7fafc; border-radius: 8px;">
                                <div style="font-size: 2em; font-weight: 700; color: #ed8936;">${data.data.n_interactions}</div>
                                <div style="color: #718096;">상호작용 수</div>
                            </div>
                            <div style="text-align: center; padding: 16px; background: #f7fafc; border-radius: 8px;">
                                <div style="font-size: 2em; font-weight: 700; color: #e53e3e;">${(data.data.sparsity * 100).toFixed(1)}%</div>
                                <div style="color: #718096;">희소성</div>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div class="error">LightGCN 데이터가 없습니다.</div>`;
                }
            } catch (error) {
                console.error('LightGCN 상태 로드 오류:', error);
                document.getElementById('lightgcn-status').innerHTML = `<div class="error">데이터 로드 실패</div>`;
            }
        }

        // 사용자 활동 차트 렌더링
        function renderActivityChart(data) {
            const ctx = document.getElementById('activityChart').getContext('2d');
            
            if (activityChart) {
                activityChart.destroy();
            }
            
            activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.daily_views.map(item => item.date),
                    datasets: [{
                        label: '상품 조회 수',
                        data: data.daily_views.map(item => item.count),
                        borderColor: '#4299e1',
                        backgroundColor: 'rgba(66, 153, 225, 0.1)',
                        tension: 0.4
                    }, {
                        label: '검색 수',
                        data: data.daily_searches.map(item => item.count),
                        borderColor: '#38a169',
                        backgroundColor: 'rgba(56, 161, 105, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 사용자 활동 차트 로드
        async function loadUserActivity() {
            try {
                const response = await fetch('/api/user_activity?days=7');
                const data = await response.json();
                
                if (data.status === 'success') {
                    renderActivityChart(data.data);
                }
            } catch (error) {
                console.error('활동 차트 로드 오류:', error);
            }
        }

        // 카테고리 차트 렌더링
        function renderCategoryChart(data) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (categoryChart) {
                categoryChart.destroy();
            }
            
            categoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.slice(0, 10).map(item => item.category),
                    datasets: [{
                        label: '조회 수',
                        data: data.slice(0, 10).map(item => item.count),
                        backgroundColor: 'rgba(66, 153, 225, 0.8)',
                        borderColor: '#4299e1',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 카테고리 통계 차트 로드
        async function loadCategoryStats() {
            try {
                const response = await fetch('/api/category_stats');
                const data = await response.json();
                
                if (data.status === 'success') {
                    renderCategoryChart(data.data);
                }
            } catch (error) {
                console.error('카테고리 차트 로드 오류:', error);
            }
        }

        // 인기 상품 로드
        async function loadPopularProducts() {
            try {
                const response = await fetch('/api/popular_products?days=7&limit=10');
                const data = await response.json();
                
                const container = document.getElementById('popular-products');
                
                if (data.status === 'success') {
                    const tableHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>순위</th>
                                    <th>상품 코드</th>
                                    <th>상품명</th>
                                    <th>카테고리</th>
                                    <th>가격</th>
                                    <th>조회 수</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.map((item, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${item.product_code}</td>
                                        <td>${item.product_name}</td>
                                        <td>${item.category}</td>
                                        <td>${item.price.toLocaleString()}원</td>
                                        <td>${item.view_count}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    container.innerHTML = tableHTML;
                } else {
                    container.innerHTML = `<div class="error">인기 상품 데이터를 불러올 수 없습니다.</div>`;
                }
            } catch (error) {
                console.error('인기 상품 로드 오류:', error);
                document.getElementById('popular-products').innerHTML = `<div class="error">데이터 로드 실패</div>`;
            }
        }

        // LightGCN 데이터 재생성
        async function regenerateLightGCNData() {
            if (!confirm('LightGCN 데이터를 재생성하시겠습니까?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/regenerate_lightgcn_data?min_interactions=3');
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert('LightGCN 데이터가 성공적으로 재생성되었습니다.');
                    loadLightGCNStatus();
                } else {
                    alert('데이터 재생성 실패: ' + data.message);
                }
            } catch (error) {
                console.error('데이터 재생성 오류:', error);
                alert('데이터 재생성 중 오류가 발생했습니다.');
            }
        }

        // 통계 새로고침
        function refreshStats() {
            loadStatistics();
            loadUserActivity();
            loadCategoryStats();
            loadPopularProducts();
        }

        // 데이터 내보내기
        function exportData() {
            alert('데이터 내보내기 기능은 추후 구현 예정입니다.');
        }

        // 기간 변경
        function changePeriod() {
            currentPeriod = document.getElementById('period-select').value;
            loadUserActivity();
            loadCategoryStats();
            loadPopularProducts();
        }

        // 기간별 통계 조회
        async function loadPeriodStats() {
            const periodSection = document.getElementById('period-stats-section');
            const periodContent = document.getElementById('period-stats-content');
            
            periodSection.style.display = 'block';
            periodContent.innerHTML = '<div class="loading">기간별 통계 로딩 중...</div>';
            
            try {
                const days = currentPeriod === 'all' ? 365 : currentPeriod;
                const response = await fetch(`/api/period_stats?days=${days}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const stats = data.data;
                    periodContent.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div style="text-align: center; padding: 16px; background: #f7fafc; border-radius: 8px;">
                                <div style="font-size: 1.8em; font-weight: 700; color: #4299e1;">${stats.period_users}</div>
                                <div style="color: #718096;">기간 내 사용자</div>
                            </div>
                            <div style="text-align: center; padding: 16px; background: #f7fafc; border-radius: 8px;">
                                <div style="font-size: 1.8em; font-weight: 700; color: #38a169;">${stats.period_views}</div>
                                <div style="color: #718096;">기간 내 조회수</div>
                            </div>
                            <div style="text-align: center; padding: 16px; background: #f7fafc; border-radius: 8px;">
                                <div style="font-size: 1.8em; font-weight: 700; color: #ed8936;">${stats.period_searches}</div>
                                <div style="color: #718096;">기간 내 검색수</div>
                            </div>
                            <div style="text-align: center; padding: 16px; background: #f7fafc; border-radius: 8px;">
                                <div style="font-size: 1.8em; font-weight: 700; color: #e53e3e;">${stats.daily_avg_views}</div>
                                <div style="color: #718096;">일평균 조회수</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <div>
                                <h4 style="margin-bottom: 16px; color: #2d3748;">기간 내 인기 상품</h4>
                                <div style="background: #f7fafc; border-radius: 8px; padding: 16px; max-height: 300px; overflow-y: auto;">
                                    ${stats.popular_products.map((product, index) => `
                                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                                            <span style="font-weight: 600;">${index + 1}. ${product.product_name}</span>
                                            <span style="color: #718096;">${product.view_count}회</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 16px; color: #2d3748;">기간 내 인기 카테고리</h4>
                                <div style="background: #f7fafc; border-radius: 8px; padding: 16px; max-height: 300px; overflow-y: auto;">
                                    ${stats.popular_categories.map((category, index) => `
                                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                                            <span style="font-weight: 600;">${index + 1}. ${category.category}</span>
                                            <span style="color: #718096;">${category.view_count}회</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    periodContent.innerHTML = `<div class="error">${data.message}</div>`;
                }
            } catch (error) {
                console.error('기간별 통계 로드 오류:', error);
                periodContent.innerHTML = '<div class="error">기간별 통계 로드 중 오류가 발생했습니다.</div>';
            }
        }

        // 통계 초기화 확인 모달 표시
        function showResetConfirm() {
            document.getElementById('reset-modal').style.display = 'block';
            document.getElementById('confirm-text').value = '';
            document.getElementById('confirm-reset-btn').disabled = true;
        }

        // 통계 초기화 확인 모달 숨기기
        function hideResetConfirm() {
            document.getElementById('reset-modal').style.display = 'none';
        }

        // 통계 초기화 실행
        async function confirmReset() {
            try {
                const response = await fetch('/api/reset_statistics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ confirm: true })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert('통계 데이터가 성공적으로 초기화되었습니다.');
                    hideResetConfirm();
                    // 모든 데이터 새로고침
                    loadStatistics();
                    loadLightGCNStatus();
                    loadUserActivity();
                    loadCategoryStats();
                    loadPopularProducts();
                } else {
                    alert('초기화 실패: ' + data.message);
                }
            } catch (error) {
                console.error('초기화 오류:', error);
                alert('초기화 중 오류가 발생했습니다.');
            }
        }

        // 사용자 활동 차트 로드 (기간별 지원)
        async function loadUserActivity() {
            try {
                const days = currentPeriod === 'all' ? 30 : currentPeriod;
                const response = await fetch(`/api/user_activity?days=${days}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    renderActivityChart(data.data);
                }
            } catch (error) {
                console.error('사용자 활동 로드 오류:', error);
            }
        }

        // 카테고리 통계 로드 (기간별 지원)
        async function loadCategoryStats() {
            try {
                const days = currentPeriod === 'all' ? null : currentPeriod;
                const url = days ? `/api/category_stats?days=${days}` : '/api/category_stats';
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.status === 'success') {
                    renderCategoryChart(data.data);
                }
            } catch (error) {
                console.error('카테고리 통계 로드 오류:', error);
            }
        }

        // 인기 상품 로드 (기간별 지원)
        async function loadPopularProducts() {
            try {
                const days = currentPeriod === 'all' ? 365 : currentPeriod;
                const response = await fetch(`/api/popular_products?days=${days}&limit=10`);
                const data = await response.json();
                
                const container = document.getElementById('popular-products');
                
                if (data.status === 'success') {
                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>순위</th>
                                    <th>상품명</th>
                                    <th>카테고리</th>
                                    <th>조회수</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.map((product, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${product.product_name}</td>
                                        <td>${product.category || '-'}</td>
                                        <td>${product.view_count}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = `<div class="error">${data.message}</div>`;
                }
            } catch (error) {
                console.error('인기 상품 로드 오류:', error);
            }
        }
    </script>

    <!-- 통계 초기화 확인 모달 -->
    <div id="reset-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; max-width: 400px; text-align: center;">
            <h3 style="color: #e53e3e; margin-bottom: 20px;">⚠️ 통계 데이터 초기화</h3>
            <p style="margin-bottom: 20px; color: #4a5568;">
                모든 사용자 이벤트 데이터가 영구적으로 삭제됩니다.<br>
                이 작업은 되돌릴 수 없습니다.
            </p>
            <div style="margin-bottom: 20px;">
                <input type="text" id="confirm-text" placeholder="'초기화'를 입력하세요" 
                       style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
            <div>
                <button class="button danger" onclick="confirmReset()" id="confirm-reset-btn" disabled>초기화 실행</button>
                <button class="button" onclick="hideResetConfirm()" style="margin-left: 10px;">취소</button>
            </div>
        </div>
    </div>
</body>
</html> 